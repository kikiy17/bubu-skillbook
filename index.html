<!doctype html>
<html lang="zh-Hant"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>è·æ¥­æŠ€èƒ½æ‰‹å†Š</title>
<style>
/* tabs åº•ä¸‹ç•™ç©ºï¼Œé¿å… select å½ˆå‡ºæ¸…å–®è“‹åˆ°åˆ†é  */
header .tabs { margin-bottom: 14px; }

/* è£å‚™é‚£æ’å†å¤šç•™ä¸€é»ç©ºé–“ï¼Œå› ç‚º select è¼ƒå¤š */
#controlsEquips { margin-top: 8px; }
body{font-family:ui-sans-serif,system-ui,"Noto Sans TC","PingFang TC";background:#0b1020;color:#eef3ff;margin:0}
header{position:sticky;top:0;background:#0f1730;border-bottom:1px solid #1d2a52;padding:12px;z-index:10}
.wrap{max-width:1080px;margin:0 auto;padding:0 12px}
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:6px 10px;border:1px solid #2f467a;border-radius:10px;background:#0d1630;cursor:pointer;font-size:14px}
.tab.active{background:#1a2a54}
.controls{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;gap:8px}
input,select{padding:8px 10px;background:#0b1630;color:#e6ecff;border:1px solid #223158;border-radius:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:16px 0 40px}
.card{background:#111a36;border:1px solid #23305a;border-radius:14px;padding:12px}
.pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2f467a;background:#0d1630;color:#9fc5ff;white-space:nowrap}
.meta{opacity:.7;font-size:12px}
.small{font-size:12px;opacity:.9}
.section{margin-top:6px}
.kv{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.kv span{white-space:nowrap}
.badge{display:inline-block;padding:2px 6px;border:1px solid #2f467a;border-radius:8px;font-size:12px;margin-right:6px}
.skillchip{display:inline-block;font-size:12px;padding:2px 6px;border-radius:8px;background:#16224a;border:1px solid #2b4380;margin:2px 6px 0 0}
.row{display:flex;align-items:center;gap:8px}
.emoji{font-size:20px}
</style></head>
<body>
<header><div class="wrap">
  <h1>ğŸ»å¸ƒå¸ƒå¹»æƒ³è·æ¥­æŠ€èƒ½æ‰‹å†ŠğŸ»</h1>

  <div class="tabs">
    <div id="tabJobs" class="tab active">è·æ¥­</div>
    <div id="tabSkills" class="tab">æŠ€èƒ½</div>
    <div id="tabPokemons" class="tab">æ­¦é­‚</div>
    <div id="tabEquips" class="tab">è£å‚™</div>
  </div>

  <div id="controlsSkills" class="controls">
    <input id="q" placeholder="ğŸ” æœå°‹ï¼šæŠ€èƒ½ / è·æ¥­ / æ–‡å­—æè¿°"/>
    <select id="job"><option value="">è·æ¥­ï¼ˆå…¨éƒ¨ï¼‰</option></select>
    <select id="type"><option value="">é¡å‹ï¼ˆå…¨éƒ¨ï¼‰</option><option value="active">ä¸»å‹•</option><option value="passive">è¢«å‹•</option></select>
    <select id="target"><option value="">ç›®æ¨™ï¼ˆå…¨éƒ¨ï¼‰</option><option value="enemy">æ•µæ–¹</option><option value="self">è‡ªèº«</option><option value="team">æˆ‘æ–¹å…¨é«”</option><option value="allyTeam">æˆ‘æ–¹å…¨é«”(allyTeam)</option></select>
    <select id="tier"><option value="">è½‰è·éšå±¤ï¼ˆå…¨éƒ¨ï¼‰</option><option value="1">ä¸€è½‰</option><option value="2">äºŒè½‰</option><option value="3">ä¸‰è½‰</option></select>
  </div>

  <div id="controlsJobs" class="controls" style="display:none">
    <input id="qJob" placeholder="ğŸ” æœå°‹ï¼šè·æ¥­ / æŠ€èƒ½åç¨±"/>
    <select id="tierJob"><option value="">è½‰è·éšå±¤ï¼ˆå…¨éƒ¨ï¼‰</option><option value="0">é›¶è½‰</option><option value="1">ä¸€è½‰</option><option value="2">äºŒè½‰</option><option value="3">ä¸‰è½‰</option></select>
    <div></div><div></div><div></div>
  </div>

  <div id="controlsPokemons" class="controls" style="display:none">
  <input id="qPoke" placeholder="ğŸ” æœå°‹ï¼šæ­¦é­‚åç¨± / çµ•æ‹›"/>
  <select id="rarityPoke">
    <option value="">ç¨€æœ‰åº¦ï¼ˆå…¨éƒ¨ï¼‰</option>
    <option value="æ™®é€š">æ™®é€š</option>
    <option value="ç¨€æœ‰">ç¨€æœ‰</option>
    <option value="å‚³èªª">å‚³èªª</option>
  </select>
  <select id="typePoke">
    <option value="">é¡å‹ï¼ˆå…¨éƒ¨ï¼‰</option>
    <option value="åŸåˆä¹‹ç¸">åŸåˆä¹‹ç¸</option>
    <option value="å¯å¯æ„›æ„›">å¯å¯æ„›æ„›</option>
    <option value="ç²¾éˆè© è€…">ç²¾éˆè© è€…</option>
    <option value="æ˜Ÿç•Œä¹‹å­">æ˜Ÿç•Œä¹‹å­</option>
  </select>
  <div></div><div></div>
</div>

<div id="controlsEquips" class="controls" style="display:none">
  <input id="qEquip" placeholder="ğŸ” æœå°‹ï¼šè£å‚™åç¨± / å¥—è£å / å…è¨±è·æ¥­"/>
  <select id="slotEquip">
    <option value="">éƒ¨ä½ï¼ˆå…¨éƒ¨ï¼‰</option>
    <option value="weapon">æ­¦å™¨</option><option value="head">é ­éƒ¨</option>
    <option value="body">èº«é«”</option><option value="gloves">æ‰‹å¥—</option>
    <option value="boots">é‹å­</option>
  </select>
  <select id="rarityEquip">
    <option value="">ç¨€æœ‰åº¦ï¼ˆå…¨éƒ¨ï¼‰</option>
    <option value="common">ä¸€èˆ¬</option>
    <option value="rare">ç¨€æœ‰</option>
    <option value="legend">å‚³èªª</option>
    <option value="god">ç¥å…µ</option>
  </select>
  <select id="jobEquip">
    <option value="">è·æ¥­ï¼ˆå…¨éƒ¨ï¼‰</option>
  </select>
  <select id="setEquip"><option value="">å¥—è£ï¼ˆå…¨éƒ¨ï¼‰</option></select>
  <div></div>
</div>


  <div class="meta" id="meta"></div>
</div></header>
<main><div class="wrap"><div id="grid" class="grid"></div></div></main>
<script>
let ALL_SKILLS=[], ALL_JOBS=[], ALL_POKEMONS=[], ALL_EQUIPS=[], ALL_EQUIPSETS=[];
const TIER_LABEL = {0:'é›¶è½‰',1:'ä¸€è½‰',2:'äºŒè½‰',3:'ä¸‰è½‰'};
const TYPE_LABEL = {active:'ä¸»å‹•', passive:'è¢«å‹•'};
const TARGET_LABEL = {enemy:'æ•µæ–¹', self:'è‡ªèº«', team:'æˆ‘æ–¹å…¨é«”', allyTeam:'æˆ‘æ–¹å…¨é«”(allyTeam)'};

fetch('./skills.json').then(r=>r.json()).then(({meta, skills, jobs, pokemons, equips, equipSets})=>{
  ALL_SKILLS   = skills   || [];
  ALL_JOBS     = jobs     || [];
  ALL_POKEMONS = pokemons || [];
  ALL_EQUIPS   = equips   || [];
  ALL_EQUIPSETS= equipSets|| [];

  document.getElementById('meta').textContent =
    'æŠ€èƒ½ ' + ALL_SKILLS.length + 'ï½œè·æ¥­ ' + ALL_JOBS.length +
    'ï½œæ­¦é­‚ ' + ALL_POKEMONS.length + 'ï½œè£å‚™ ' + ALL_EQUIPS.length +
    ' ï½œæ›´æ–°ï¼š' + new Date(meta.lastUpdated).toLocaleString();

    
  buildJobOptions(ALL_SKILLS);
  buildEquipJobOptions(ALL_JOBS);
  buildSetOptions(ALL_EQUIPSETS);   // NEW
  renderJobs();


});

function buildSetOptions(sets){
  const sel = document.getElementById('setEquip');
  if (!sel) return;
  (sets||[]).forEach(s=>{
    const o=document.createElement('option'); o.value=s.id; o.textContent=s.name; sel.appendChild(o);
  });
}


// ====== è£å‚™å¡ç‰‡æ¨£å¼ ======
function pct(n){ return Math.round((Number(n||0))*100)+'%'; }

function fmtStatKV(base){
  const pctKeys = new Set([
    'atkPct','defPct','critRate','critDamageBonus','dodge','blockUp',
    'skillMul','skillDmgReduce','dmgReduce','trueDamage',
    'followUpChance','followUpMultiplier','specialAttackDamage',
    'strongAgainstBonus','healUp','defensePierce'
  ]);
  return Object.keys(base||{}).map(k=>{
    const v = base[k];
    const val = (typeof v === 'number' && pctKeys.has(k)) ? pct(v) : v;
    return '<span>'+k+' '+val+'</span>';
  }).join(' ');
}


function setNameById(id){
  const s=(ALL_EQUIPSETS||[]).find(x=>x.id===id);
  return s ? s.name : '';
}
function buildEquipJobOptions(jobs){
  const sel = document.getElementById('jobEquip');
  if (!sel) return;
  // ç”¨è·æ¥­åç¨±å»é‡ã€æ’åº
  const names = Array.from(new Set((jobs||[]).map(j => j.name).filter(Boolean)))
                     .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
  names.forEach(name=>{
    const o = document.createElement('option');
    o.value = name;
    o.textContent = name;
    sel.appendChild(o);
  });
}

function cardEquip(e){
  const tags = [
    '<span class="pill">'+(e.slotLabel || e.slot || '-')+'</span>',

    '<span class="pill">'+(e.rarity||'-')+'</span>',
    (e.setId ? '<span class="pill">'+setNameById(e.setId)+'</span>' : '')
  ].join(' ');

  // NEWï¼šé¡¯ç¤ºå‰ä¸‰å€‹ä¸­æ–‡è·æ¥­åï¼Œ>3 ç”¨ â€¦
  const jobArr = (e.allowedJobNames && e.allowedJobNames.length ? e.allowedJobNames : e.allowedJobs) || [];
  // const jobs = jobArr.slice(0,3).join('ã€') + (jobArr.length>3 ? 'â€¦' : '');
  //é¡¯ç¤ºè·æ¥­æ•¸é‡
  const jobs = jobArr.join('ã€');

  // NEWï¼šå„ªå…ˆä½¿ç”¨ export æ™‚å·²ç¶“æ ¼å¼åŒ–å¥½çš„ baseDisplay
  const baseHtml = (e.baseDisplay && e.baseDisplay.length)
    ? e.baseDisplay.map(s => '<span>'+s+'</span>').join(' ')
    : fmtStatKV(e.base || {});

  return [
    '<div class="card">',
      '<div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px">',
        '<h3 style="margin:0">', e.name ,'</h3>',
        '<div>', tags ,'</div>',
      '</div>',
      '<div class="small kv">',
        '<span>è£å‚™ç­‰ç´š ', (e.gearLevel??'-'), '</span>',
        '<span>éœ€æ±‚ç­‰ç´š ', (e.requiredLevel??'-'), '</span>',
        (e.holes!=null ? ('<span>å­”ä½ '+e.holes+'</span>') : ''),
      '</div>',
      '<div class="small kv">', baseHtml, '</div>',
      (jobArr.length ? ('<div class="small">å¯ç”¨è·æ¥­ï¼š'+jobs+'</div>') : ''),
    '</div>'
  ].join('');
}


function renderEquips(){
  const q    = (document.getElementById('qEquip')?.value||'').toLowerCase();
  const slot = (document.getElementById('slotEquip')?.value||'');
  const rar  = (document.getElementById('rarityEquip')?.value||'');
  const set  = (document.getElementById('setEquip')?.value||'');
  const job  = (document.getElementById('jobEquip')?.value||''); // â˜… æ–°å¢

  const list = (ALL_EQUIPS||[]).filter(e=>{
    if (q){
      // æœç´¢ä¹Ÿç´å…¥è·æ¥­ä¸­æ–‡å
      const jobNames = (e.allowedJobNames || e.allowedJobs || []).join(' ');
      const hay = (e.name+' '+(setNameById(e.setId)||'')+' '+jobNames).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (slot && e.slot !== slot) return false;
    if (rar && e.rarity !== rar) return false;
    if (set && e.setId !== set) return false;

    // â˜… è·æ¥­éæ¿¾ï¼ˆallowedJobNames ç‚ºç©ºæˆ–ä¸å­˜åœ¨ â†’ è¦–ç‚ºã€Œä¸é™è·æ¥­ã€ï¼‰
    if (job){
      const names = e.allowedJobNames || [];
      const unrestricted = !names || names.length === 0;
      if (!unrestricted && !names.includes(job)) return false;
    }

    return true;
  });

  document.getElementById('grid').innerHTML = list.map(cardEquip).join('');
}


// ç¶å®š
['qEquip','slotEquip','rarityEquip','setEquip','jobEquip'].forEach(id=>{
  const el=document.getElementById(id);
  if (el){ el.addEventListener('input',renderEquips); el.addEventListener('change',renderEquips); }
});
const tabEquips = document.getElementById('tabEquips');
const controlsEquips = document.getElementById('controlsEquips');

tabEquips.addEventListener('click', ()=>{
  tabEquips.classList.add('active');
  tabJobs.classList.remove('active');
  tabSkills.classList.remove('active');
  tabPokemons.classList.remove('active');

  controlsEquips.style.display='';
  controlsJobs.style.display='none';
  controlsSkills.style.display='none';
  controlsPokemons.style.display='none';

  renderEquips();
});

// ====== æ­¦é­‚å¡ç‰‡æ¨£å¼ ======
function spanIfNum(label, value, fmt){
  const n = Number(value);
  if (!isFinite(n) || n === 0) return '';
  const text = fmt ? fmt(n) : n;
  return '<span>' + label + ' ' + text + '</span>';
}

function cardPokemon(p){
  const r = '<span class="pill">' + (p.rarity || 'â€”') + '</span>';
  const t = '<span class="pill">' + (p.type || 'â€”') + '</span>';

  return [
    '<div class="card">',
      '<div style="display:flex;justify-content:space-between;align-items:center">',
        '<h3>', p.name, '</h3>',
        '<div>', r, ' ', t, '</div>',
      '</div>',
      '<div class="small kv">',
        spanIfNum('æ”»æ“Š', p.basicattack),
        spanIfNum('çˆ†ç‡', p.criticalRate, pct),
        spanIfNum('çˆ†å‚·', p.criticalDamage, pct),
        spanIfNum('é€ å‚·', p.additionalDamage, pct),
        spanIfNum('ç©¿é˜²', p.defensePierce, pct),
        // spanIfNum('æ³¢å‹•', p.damageVariance, pct),
        (p.forceCritical ? '<span>å¿…çˆ†</span>' : ''),
      '</div>',
      (p.special
        ? '<div class="small">âœ¨å¥§ç¾© <b>' + p.special.name + '</b>ï¼ˆèƒ½é‡ ' +
          (p.special.costEnergy ?? '-') + 'ï½œå€ç‡Ã—' + (p.special.damageMultiplier ?? '-') + 'ï¼‰</div>'
        : ''
      ),
    '</div>'
  ].join('');
}


function renderPokemons(){
  const elQ = document.getElementById('qPoke');
  const q = String((elQ && elQ.value) || '').toLowerCase();
  const rarity = (document.getElementById('rarityPoke')?.value) || '';
  const type = (document.getElementById('typePoke')?.value) || '';

  const list = (ALL_POKEMONS || []).filter(function(p){
    if (q) {
      // ä¸èƒ½ç”¨å…§å±¤åå¼•è™Ÿï¼›ç”¨å­—ä¸²æ‹¼æ¥ä¸¦ä¿éšªè½‰å­—ä¸²
      var hay = String(p?.name || '') + String(p?.special?.name || '');
      if (hay.toLowerCase().indexOf(q) === -1) return false;
    }
    if (rarity && p.rarity !== rarity) return false;
    if (type && p.type !== type) return false;
    return true;
  });

  document.getElementById('grid').innerHTML = list.map(cardPokemon).join('');
}

// ç¶å®šæœå°‹äº‹ä»¶
['qPoke','rarityPoke','typePoke'].forEach(id=>{
   const el = document.getElementById(id);
   if (!el) return;
   el.addEventListener('input', renderPokemons);
   el.addEventListener('change', renderPokemons);
 });

// ====== Tab åˆ‡æ› ======
const tabJobs = document.getElementById('tabJobs');
const tabSkills = document.getElementById('tabSkills');
const tabPokemons = document.getElementById('tabPokemons');
const controlsJobs = document.getElementById('controlsJobs');
const controlsSkills = document.getElementById('controlsSkills');
const controlsPokemons = document.getElementById('controlsPokemons');

function blurActiveSelect(){
  const ae = document.activeElement;
  if (ae && ae.tagName === 'SELECT') ae.blur();
}

// åˆ†é è¢«æŒ‰ä¸‹(è€Œä¸æ˜¯é»æ“Šå®Œæˆ)å‰å°±å…ˆ blurï¼ŒiOS/Safari ä¹ŸæŠ“ touchstart
[tabJobs, tabSkills, tabPokemons, tabEquips].forEach(el=>{
  el.addEventListener('mousedown', blurActiveSelect);
  el.addEventListener('touchstart', blurActiveSelect, {passive:true});
});


tabPokemons.addEventListener('click', ()=>{
  tabPokemons.classList.add('active');
  tabJobs.classList.remove('active');
  tabSkills.classList.remove('active');
  tabEquips.classList.remove('active');

  controlsPokemons.style.display = '';
  controlsJobs.style.display = 'none';
  controlsSkills.style.display = 'none';
  controlsEquips.style.display = 'none';

  renderPokemons();
});

tabSkills.addEventListener('click', ()=>{
  tabSkills.classList.add('active');
  tabJobs.classList.remove('active');
  tabPokemons.classList.remove('active');
  tabEquips.classList.remove('active');

  controlsSkills.style.display = '';
  controlsJobs.style.display = 'none';
  controlsPokemons.style.display = 'none';
  controlsEquips.style.display = 'none'; 

  renderSkills();
});

tabJobs.addEventListener('click', ()=>{
  tabJobs.classList.add('active');
  tabSkills.classList.remove('active');
  tabPokemons.classList.remove('active');
  tabEquips.classList.remove('active'); 

  controlsJobs.style.display = '';
  controlsSkills.style.display = 'none';
  controlsPokemons.style.display = 'none';
  controlsEquips.style.display = 'none';

  renderJobs();
});

function pct(n){return Math.round((Number(n||0))*100)+'%'}
function mapTarget(t){ return TARGET_LABEL[t] || t || 'â€”'; }
function mapType(t){ return TYPE_LABEL[t] || t || 'â€”'; }
function mapTier(n){ return TIER_LABEL[n] || ('Tier '+n); }


function fmtEffects(e, s){
  if(!e||!Object.keys(e).length) return 'â€”';
  const out=[];
  if(e.stun) out.push('æšˆçœ© ' + e.stun.duration + 's');
  if(e.mark) out.push('æ¨™è¨˜ å—å‚·+' + pct(e.mark.damageTakenUp) + ' / ' + (e.mark.duration||'-') + 's');
  if(e.teamDamageReduce) out.push('å…¨é«”æ¸›å‚· ' + pct(e.teamDamageReduce.amount) + ' / ' + e.teamDamageReduce.duration + 's');
  if(e.selfBuff && e.selfBuff.damageReduce) out.push('è‡ªæˆ‘æ¸›å‚· ' + pct(e.selfBuff.damageReduce.amount) + ' / ' + e.selfBuff.damageReduce.duration + 's');
  if(e.defensePierce) out.push('ç©¿é€ +' + pct(e.defensePierce));
  if(e.followUpChance) out.push('è¿½æ“Šæ©Ÿç‡ +' + pct(e.followUpChance));
  if(e.followUpMultiplier) out.push('è¿½æ“Šå€ç‡ +' + pct(e.followUpMultiplier));
  if(e.forceCrit) out.push('å¿…å®šçˆ†æ“Š');
  if(e.lowHpDamageUp) out.push('æ–¬æ®ºï¼šç›®æ¨™HPä½æ–¼ ' + pct(e.lowHpDamageUp.threshold) + 'ï¼ŒåŠ æˆ ' + pct(e.lowHpDamageUp.bonus));
  if(e.damageUp) out.push('å¢å‚· +' + pct(e.damageUp));
  if (e.teamDamageReduceAura) out.push('å¸¸é§æ¸›å‚·å…‰ç’° +' + pct(e.teamDamageReduceAura));
  if (e.heal === true) out.push((s && s.target === 'team') ? 'ç¾¤é«”æ²»ç™‚' : 'æ²»ç™‚');
  if (e.healBase != null) out.push('åŸºç¤æ²»ç™‚ +' + e.healBase);
  if (e.atkDown) out.push('é™æ”» ' + pct(e.atkDown.amount) + ' / ' + e.atkDown.duration + 's');
  if (e.pokemonCriticalRateBonus) out.push('æ­¦é­‚çˆ†æ“Šç‡ +' + pct(e.pokemonCriticalRateBonus));
  if (e.pokemonCritDamageBonus) out.push('æ­¦é­‚çˆ†å‚· +' + pct(e.pokemonCritDamageBonus));
  if (e.enemyCritRateDown) out.push('æ•µæ–¹çˆ†æ“Šç‡é™ä½ ' + pct(e.enemyCritRateDown));
  if (e.enemyCritDamageDown) out.push('æ•µæ–¹çˆ†å‚·é™ä½ ' + pct(e.enemyCritDamageDown));
  if (e.execute && e.execute.threshold != null && e.execute.bonus != null)
    out.push('æ–¬æ®ºï¼šè‡ªèº«HPä½æ–¼ ' + pct(e.execute.threshold) + ' æ™‚ï¼Œå¢å‚· ' + pct(e.execute.bonus));
  if (e.selfBuff && e.selfBuff.defensePierce != null)
    out.push('è‡ªæˆ‘ç©¿é€ +' + pct(e.selfBuff.defensePierce) + ' / ' + (e.selfBuff.duration || '-') + 's');
  if (e.payHpRatio) out.push('æŠ€èƒ½åå™¬HP ' + pct(e.payHpRatio));
  if(e.blockUp) out.push('æ ¼æ“‹ +' + pct(e.blockUp));
  if(e.healUp) out.push('å—ç™‚ +' + pct(e.healUp));
  if(e.recoveryReduce) out.push('å£“åˆ¶å›å¾© ' + pct(e.recoveryReduce));
  if (e.dodgeUp) out.push('é–ƒé¿ç‡ +' + pct(e.dodgeUp));
  if (e.critRateBonus) out.push('çˆ†æ“Šç‡ +' + pct(e.critRateBonus));
  if (e.criticalDamageBonus) out.push('çˆ†å‚· +' + pct(e.criticalDamageBonus));
  if (typeof e.trueDamage === 'number') out.push('è¿½åŠ çœŸå¯¦å‚·å®³ ' + pct(e.trueDamage));
  else if (e.trueDamage && e.trueDamage.ratio) out.push('è¿½åŠ çœŸå¯¦å‚·å®³ ' + pct(e.trueDamage.ratio));
  if (e.specialAttackDamage) out.push('å¥§ç¾©å‚·å®³ +' + pct(e.specialAttackDamage));
  if (e.strongAgainstBonus) out.push('å…‹åˆ¶å‚·å®³ +' + pct(e.strongAgainstBonus));
  if (e.pokemonAttackBonus) out.push('æ­¦é­‚æ”»æ“Š +' + pct(e.pokemonAttackBonus));
  if (e.selfBuff && e.selfBuff.statsUp && e.selfBuff.statsUp.pokemonAttackBonus) {
    const dur = (e.selfBuff.duration != null) ? (' / ' + e.selfBuff.duration + 's') : '';
    out.push('æ­¦é­‚æ”»æ“Š +' + pct(e.selfBuff.statsUp.pokemonAttackBonus) + dur);
  }
  if (e.conditional) {
    const c = e.conditional;
    if (c.ifTargetHpBelow != null && c.damageUp != null)
      out.push('è™•æ±ºåŠ æˆï¼šç›®æ¨™HPä½æ–¼ ' + pct(c.ifTargetHpBelow) + ' æ™‚ï¼Œå¢å‚· ' + pct(c.damageUp));
    if (c.ifTargetHpAbove != null && c.critRateBonus != null)
      out.push('å…ˆæ‰‹åŠ æˆï¼šç›®æ¨™HPé«˜æ–¼ ' + pct(c.ifTargetHpAbove) + ' æ™‚ï¼Œçˆ†æ“Šç‡ +' + pct(c.critRateBonus));
  }
  if (e.guaranteedDodge) out.push('å¿…å®šé–ƒé¿ ' + e.guaranteedDodge + ' æ¬¡');
  return out.join(' ï¼ ');
}

function fmtScaling(sc){
  const ks = Object.keys(sc||{});
  return ks.length ? ('å±¬æ€§åŠ æˆï¼š' + ks.map(k=>k+' Ã—'+sc[k]).join('ã€')) : '';
}
function starTitleByType(t){ return t==='active' ? 'æŠ€èƒ½å‚·å®³å€ç‡' : 'è¢«å‹•å±¬æ€§å€ç‡'; }
function fmtStars(ss){ return (ss||[]).map(x=>'â˜…'+x.star+' Ã—'+x.multiplier).join(' ï½œ ') || 'â€”'; }

function fmtStarExtras(upgrade){
  var extras = (upgrade && upgrade.extraEffectsByStar) || {};
  var keys = Object.keys(extras).map(function(n){ return Number(n); }).sort(function(a,b){ return a-b; });
  if (!keys.length) return '';
  var lines = [];
  for (var i=0;i<keys.length;i++){
    var k = keys[i];
    var ex = extras[k];
    if (ex.forceCrit) lines.push('â˜…' + k + ' â†’ å¿…å®šçˆ†æ“Š');
    if (ex.defensePierce) lines.push('â˜…' + k + ' â†’ ç©¿é€ +' + pct(ex.defensePierce));
    if (ex.followUpChance) lines.push('â˜…' + k + ' â†’ è¿½æ“Šæ©Ÿç‡ +' + pct(ex.followUpChance));
    if (ex.followUpMultiplier) lines.push('â˜…' + k + ' â†’ è¿½æ“Šå€ç‡ +' + pct(ex.followUpMultiplier));
    if (ex.mark && ex.mark.damageTakenUp) lines.push('â˜…' + k + ' â†’ æ¨™è¨˜ å—å‚·+' + pct(ex.mark.damageTakenUp) + ' / ' + (ex.mark.duration || '-') + 's');
    if (ex.stun && ex.stun.duration) lines.push('â˜…' + k + ' â†’ æšˆçœ© ' + ex.stun.duration + 's');
    if (ex.nextSkillDamageUp) lines.push('â˜…' + k + ' â†’ ä¸‹ä¸€æ‹›å‚·å®³ +' + pct(ex.nextSkillDamageUp));
    if (ex.selfBuff && ex.selfBuff.damageReduce) lines.push('â˜…' + k + ' â†’ è‡ªæˆ‘æ¸›å‚· ' + pct(ex.selfBuff.damageReduce.amount) + ' / ' + ex.selfBuff.duration + 's');
    if (ex.blockUp) lines.push('â˜…' + k + ' â†’ æ ¼æ“‹ +' + pct(ex.blockUp));
    if (ex.healUp) lines.push('â˜…' + k + ' â†’ å—ç™‚ +' + pct(ex.healUp));
    if (ex.recoveryReduce) lines.push('â˜…' + k + ' â†’ å£“åˆ¶å›å¾© ' + pct(ex.recoveryReduce));
    if (ex.specialAttackDamage) lines.push('â˜…' + k + ' â†’ å¥§ç¾©å‚·å®³ +' + pct(ex.specialAttackDamage));
    if (ex.strongAgainstBonus) lines.push('â˜…' + k + ' â†’ å…‹åˆ¶å‚·å®³ +' + pct(ex.strongAgainstBonus));
    if (ex.dodgeUp) lines.push('â˜…' + k + ' â†’ é–ƒé¿ç‡ +' + pct(ex.dodgeUp));
    if (ex.critRateBonus) lines.push('â˜…' + k + ' â†’ çˆ†æ“Šç‡ +' + pct(ex.critRateBonus));
    if (ex.criticalDamageBonus) lines.push('â˜…' + k + ' â†’ çˆ†å‚· +' + pct(ex.criticalDamageBonus));
    if (typeof ex.trueDamage === 'number') lines.push('â˜…' + k + ' â†’ è¿½åŠ çœŸå¯¦å‚·å®³ ' + pct(ex.trueDamage));
    if (ex.trueDamage && ex.trueDamage.ratio) lines.push('â˜…' + k + ' â†’ è¿½åŠ çœŸå¯¦å‚·å®³ ' + pct(ex.trueDamage.ratio));
    if (ex.teamDamageReduce) lines.push('â˜…' + k + ' â†’ å…¨é«”æ¸›å‚· ' + pct(ex.teamDamageReduce.amount) + ' / ' + ex.teamDamageReduce.duration + 's');
    if (ex.guaranteedDodge) lines.push('â˜…' + k + ' â†’ å¿…å®šé–ƒé¿ ' + ex.guaranteedDodge + ' æ¬¡');
    if (ex.pokemonAttackBonus) lines.push('â˜…' + k + ' â†’ æ­¦é­‚æ”»æ“Š +' + pct(ex.pokemonAttackBonus));
    if (ex.selfBuff && ex.selfBuff.statsUp && ex.selfBuff.statsUp.pokemonAttackBonus) {
      var durStar = (ex.selfBuff.duration != null) ? (' / ' + ex.selfBuff.duration + 's') : '';
      lines.push('â˜…' + k + ' â†’ æ­¦é­‚æ”»æ“Š +' + pct(ex.selfBuff.statsUp.pokemonAttackBonus) + durStar);
    }
    if (ex.teamDamageReduceAura) lines.push('â˜…' + k + ' â†’ å¸¸é§æ¸›å‚·å…‰ç’° +' + pct(ex.teamDamageReduceAura));
    if (ex.healBase != null) lines.push('â˜…' + k + ' â†’ åŸºç¤æ²»ç™‚ +' + ex.healBase);
    if (ex.atkDown) lines.push('â˜…' + k + ' â†’ é™æ”» ' + pct(ex.atkDown.amount) + ' / ' + ex.atkDown.duration + 's');
    if (ex.pokemonCriticalRateBonus) lines.push('â˜…' + k + ' â†’ æ­¦é­‚çˆ†æ“Šç‡ +' + pct(ex.pokemonCriticalRateBonus));
    if (ex.pokemonCritDamageBonus) lines.push('â˜…' + k + ' â†’ æ­¦é­‚çˆ†å‚· +' + pct(ex.pokemonCritDamageBonus));
    if (ex.enemyCritRateDown) lines.push('â˜…' + k + ' â†’ æ•µæ–¹çˆ†æ“Šç‡é™ä½ ' + pct(ex.enemyCritRateDown));
    if (ex.enemyCritDamageDown) lines.push('â˜…' + k + ' â†’ æ•µæ–¹çˆ†å‚·é™ä½ ' + pct(ex.enemyCritDamageDown));
    if (ex.execute && ex.execute.threshold != null && ex.execute.bonus != null)
      lines.push('â˜…' + k + ' â†’ æ–¬æ®ºï¼šè‡ªèº«HPä½æ–¼ ' + pct(ex.execute.threshold) + ' æ™‚ï¼Œå¢å‚· ' + pct(ex.execute.bonus));
    if (ex.selfBuff && ex.selfBuff.defensePierce != null)
      lines.push('â˜…' + k + ' â†’ è‡ªæˆ‘ç©¿é€ +' + pct(ex.selfBuff.defensePierce) + ' / ' + (ex.selfBuff.duration || '-') + 's');
    if (ex.payHpRatio) lines.push('â˜…' + k + ' â†’ æŠ€èƒ½åå™¬HP ' + pct(ex.payHpRatio));
  }
  return lines.join('\n');
}

function cardSkill(s){
  const tierTxt = mapTier(s.tier);
  const starTitle = (s.type==='active') ? 'æŠ€èƒ½å‚·å®³å€ç‡' : 'è¢«å‹•å±¬æ€§å€ç‡';
  const starSpread = (s.starSpread||[]).map(x=>'â˜…'+x.star+' Ã—'+x.multiplier).join(' ï½œ ') || 'â€”';

  return `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:baseline;gap:8px">
      <h3 style="margin:0">${s.name}</h3><span class="pill">${tierTxt}</span>
    </div>
    <div style="opacity:.95;margin:6px 0 10px">${s.description||''}</div>

    <div class="small kv">
      <span>è·æ¥­ï¼š${s.jobName||'â€”'}</span>
      <span>é¡å‹ï¼š${mapType(s.type)}</span>
      <span>ç›®æ¨™ï¼š${mapTarget(s.target)}</span>
      <span>å†·å»ï¼š${s.cooldownSec??'-'}s</span>
    </div>

    <div class="section small">
      <div><strong>æ•ˆæœï¼š</strong><br/>${(s.effectsText||'â€”').replace(/\n/g,'<br/>')}</div>
      ${s.scalingText ? ('<div style="margin-top:4px"><strong>å±¬æ€§åŠ æˆï¼š</strong>'+s.scalingText+'</div>') : ''}
    </div>

    <details class="section"><summary>${starTitle}</summary>
      <div class="small">${starSpread}</div>
      ${s.starExtrasText ? ('<div class="small" style="margin-top:6px"><strong>å‡æ˜Ÿå¾Œæ•ˆæœï¼š</strong><br/>'+s.starExtrasText.replace(/\n/g,'<br/>')+'</div>') : ''}
    </details>
  </div>`;
}


function biasBadges(bias, tier){
  const order = ['STR','INT','AGI','LUCK','END'];
  const label = { STR:'åŠ›é‡', INT:'æ™ºåŠ›', AGI:'æ•æ·', LUCK:'å¹¸é‹', END:'è€åŠ›' };
  const get = k => Math.max(0, Number((bias && bias[k]) || 0));
  const sum = order.reduce((a,k)=>a+get(k), 0);
  if (!sum) return '<span class="badge">â€”</span>';

  const mul = (tier <= 1) ? 0.8 : (tier === 2 ? 1 : 1.4); // 0/1è½‰*0.8ï¼Œ2è½‰*1ï¼Œ3è½‰*1.2

  return order.map(k=>{
    const v = get(k);
    if (!v) return '';
    const pct = Math.round((v / sum) * 100 * mul);
    return '<span class="badge">'+(label[k] || k)+': '+pct+'%</span>';
  }).filter(Boolean).join(' ');
}


function resolveParentLabel(j){
  if (!j || !j.branchFrom) return '';
  // åœ¨ ALL_JOBS è£¡æ‰¾å‡ºçˆ¶è·æ¥­
  const parent = (ALL_JOBS || []).find(x => x.id === j.branchFrom);
  if (!parent) return j.branchFrom; // æ‰¾ä¸åˆ°å°±é€€å›åŸå§‹ idï¼ˆé¿å…é¡¯ç¤ºç©ºç™½ï¼‰
  return (parent.emoji ? parent.emoji + ' ' : '') + parent.name + 'ï¼ˆ' + mapTier(parent.tier) + 'ï¼‰';
}

function cardJob(j){
  const tierTxt = mapTier(j.tier);
  const act = (j.activeSkills || []).map(a =>
    '<span class="skillchip">ã€ä¸»å‹•ã€‘' + a.name + (a.cooldownSec != null ? 'ï¼ˆ' + a.cooldownSec + 'sï¼‰' : '') + '</span>'
  ).join('');
  const pas = j.passiveSkill ? '<span class="skillchip">ã€è¢«å‹•ã€‘' + j.passiveSkill.name + '</span>' : '';

  const from = j.branchFromLabel || resolveParentLabel(j) || j.branchFrom || '';
const lvl  = (j.levelRequirement != null) ? j.levelRequirement : '-';


  return [
    '<div class="card">',
      '<div class="row">',
        '<div class="emoji">', (j.emoji || ''), '</div>',
        '<h3 style="margin:0">', j.name, '</h3>',
        '<span class="pill">', tierTxt, '</span>',
      '</div>',
      '<div class="small kv">',
         from ? ('<span>è½‰è·è‡ªï¼š' + from + '</span>') : '',
         '<span>ç­‰ç´šéœ€æ±‚ï¼š', lvl, '</span>',
      '</div>',
      '<div class="section small"><strong>å±¬æ€§å‚¾å‘ï¼š</strong> ', biasBadges(j.statBias, j.tier), '</div>',
      '<div class="section small"><strong>æŠ€èƒ½ï¼š</strong><div>', act, ' ', pas, '</div></div>',
      
    '</div>'
  ].join('');
}




// Skills æª¢è¦–
function buildJobOptions(skills){
  const set = new Set((skills||[]).map(s=>s.jobName).filter(Boolean));
  const sel = document.getElementById('job');
  [...set].sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(j=>{
    const o = document.createElement('option'); o.value=j; o.textContent=j; sel.appendChild(o);
  });
}

function renderSkills(){
  const q = (document.getElementById('q').value||'').toLowerCase();
  const job = document.getElementById('job').value;
  const type = document.getElementById('type').value;
  const target = document.getElementById('target').value;
  const tier = document.getElementById('tier').value;

  const filtered = (ALL_SKILLS||[]).filter(s=>{
    if (q) {
      const hay = (s.name+' '+(s.jobName||'')+' '+(s.description||'')).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (job && s.jobName !== job) return false;
    if (type && s.type !== type) return false;
    if (target && s.target !== target) return false;
    if (tier && String(s.tier) !== tier) return false;
    return true;
  });

  document.getElementById('grid').innerHTML = filtered.map(cardSkill).join('');
}

// Jobs æª¢è¦–
function renderJobs(){
  const q = (document.getElementById('qJob').value||'').toLowerCase();
  const tier = document.getElementById('tierJob').value;

  const filtered = (ALL_JOBS||[]).filter(j=>{
    if (q) {
      const skillNames = (j.activeSkills||[]).map(s=>s.name).concat(j.passiveSkill? [j.passiveSkill.name] : []);
      const hay = (j.name + ' ' + skillNames.join(' ')).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    if (tier && String(j.tier) !== tier) return false;
    return true;
  });

  document.getElementById('grid').innerHTML = filtered.map(cardJob).join('');
}

// ç¶å®š
['q','job','type','target','tier'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) { el.addEventListener('input', renderSkills); el.addEventListener('change', renderSkills); }
});
['qJob','tierJob'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) { el.addEventListener('input', renderJobs); el.addEventListener('change', renderJobs); }
});


</script>
</body></html>